_MF_SINGLTN(_PFX_XHR+"_AjaxResponse",_MF_OBJECT,{RESP_PARTIAL:"partial-response",RESP_TYPE_ERROR:"error",RESP_TYPE_REDIRECT:"redirect",RESP_TYPE_CHANGES:"changes",CMD_CHANGES:"changes",CMD_UPDATE:"update",CMD_DELETE:"delete",CMD_INSERT:"insert",CMD_EVAL:"eval",CMD_ERROR:"error",CMD_ATTRIBUTES:"attributes",CMD_EXTENSION:"extension",CMD_REDIRECT:"redirect",P_VIEWSTATE:"jakarta.faces.ViewState",P_CLIENTWINDOW:"jakarta.faces.ClientWindow",P_VIEWROOT:"jakarta.faces.ViewRoot",P_VIEWHEAD:"jakarta.faces.ViewHead",P_VIEWBODY:"jakarta.faces.ViewBody",P_RESOURCE:"jakarta.faces.Resource",processResponse:function(G,C){C._mfInternal=C._mfInternal||{};var B=C._mfInternal;B._updateElems=[];B._updateForms=[];B.appliedViewState=null;B.appliedClientWindow=null;B.namingModeId=null;try{var L=this.attr("impl"),E=this._Lang;if(!G||!E.exists(G,"responseXML")){throw this.makeException(new Error(),L.EMPTY_RESPONSE,L.EMPTY_RESPONSE,this._nameSpace,"processResponse","");}var F=G.responseXML;var I=E.fetchXMLErrorMessage(G.responseText||G.response,F);if(I){throw this._raiseError(new Error(),I.errorMessage+"\n"+I.sourceText+"\n"+I.visualError+"\n","processResponse");}var J=F.childNodes[0];if("undefined"==typeof J||J==null){throw this._raiseError(new Error(),"No child nodes for response","processResponse");}else{if(J.tagName!=this.RESP_PARTIAL){J=J.nextSibling;if(!J||J.tagName!=this.RESP_PARTIAL){throw this._raiseError(new Error(),"Partial response not set","processResponse");}}}B.namingModeId=(J.id||"");var M=J.childNodes.length;for(var H=0;H<M;H++){var A=J.childNodes[H];var D=A.tagName;if(D==this.CMD_ERROR){this.processError(G,C,A);}else{if(D==this.CMD_REDIRECT){this.processRedirect(G,C,A);}else{if(D==this.CMD_CHANGES){this.processChanges(G,C,A);}}}}if(B.appliedViewState){this.fixViewStates(C);}if(B.appliedClientWindow){this.fixClientWindows(C);}L.sendEvent(G,C,L["SUCCESS"]);}catch(K){if(window.console&&window.console.error){console.error(K);}throw K;}finally{delete B._updateElems;delete B._updateForms;delete B.appliedViewState;delete B.appliedClientWindow;delete B.namingModeId;}},fixViewStates:function(B){var A=this._Lang;var C=B._mfInternal;if(null==C.appliedViewState){return ;}this._updateJSFClientArtifacts(B,C.appliedViewState,this.P_VIEWSTATE);},fixClientWindows:function(B,D){var A=this._Lang;var C=B._mfInternal;if(null==C.appliedClientWindow){return ;}this._updateJSFClientArtifacts(B,C.appliedClientWindow,this.P_CLIENTWINDOW);},_applyJSFArtifactValueToForm:function(C,I,N,K){if(!I){return ;}var D=this._Lang;var M=this._Dom;var H=this._getPrefix(C);var B=[];var A=I.elements;for(var G=0,E=A.length;G<E;G++){var J=A[G];var L=J.name||"";if(L.indexOf(K)!=-1){B.push(J);}}if(B.length){D.arrForEach(B,function(O){M.setAttribute(O,"value",N);});}else{var F=this._Dom.getDummyPlaceHolder();F.innerHTML=["<input type='hidden'","id='",this._fetchUniqueId(H,K),"' name='",K,"' value='",N,"' />"].join("");try{I.appendChild(F.childNodes[0]);}finally{F.innerHTML="";}}},_fetchUniqueId:function(C,A){var B=0;var D=C+A+jsf.separatorchar+B;while(this._Dom.byId(D)!=null){B++;D=C+A+jsf.separatorchar+B;}return D;},_updateJSFClientArtifacts:function(B,J,I){var H=this._getPrefix(B);var C=(B._mfInternal._mfSourceFormId)?this._Dom.byId(B._mfInternal._mfSourceFormId):null;if(C){C=this._Dom.byId(C);if(C){this._applyJSFArtifactValueToForm(B,C,J,I);}}var G=this._getViewRoot(B);var A=this._Dom.findByTagNames(G,{"form":1})||[];if(this._RT.getLocalOrGlobalConfig(B,"no_portlet_env",false)){this._Lang.arrForEach(A,this._Lang.hitch(this,function(K){this._applyJSFArtifactValueToForm(B,K,J,I);}));}else{var F=G.id||"";for(var D=0;D<B._mfInternal._updateForms.length;D++){var E=B._mfInternal._updateForms[D];if(E.indexOf(F)!=0){continue;}else{this._applyJSFArtifactValueToForm(B,this._Dom.byId(E),J,I);}}}},_getViewRoot:function(A){var C=this._getPrefix(A);if(C==""){return document.getElementsByTagName("body")[0];}C=C.substr(0,C.length-1);var B=document.getElementById(C);if(B){return B;}return document.getElementsByTagName("body")[0];},_getPrefix:function(A){var C=A._mfInternal;var B=C.namingModeId;if(B!=""){B=B+jsf.separatorchar;}return B;},processError:function(E,B,D){var C=D.firstChild.textContent||D.firstChild.text||"",A=D.childNodes[1].firstChild.data||"";this.attr("impl").sendError(E,B,this.attr("impl").SERVER_ERROR,C,A,"myfaces._impl.xhrCore._AjaxResponse","processError");},processRedirect:function(D,B,C){var A=this._Lang;var E=C.getAttribute("url");if(!E){throw this._raiseError(new Error(),A.getMessage("ERR_RED_URL",null,"_AjaxResponse.processRedirect"),"processRedirect");}E=A.trim(E);if(E==""){return false;}window.location=E;return true;},processChanges:function(F,C,E){var D=E.childNodes;var B=this._Lang;for(var A=0;A<D.length;A++){switch(D[A].tagName){case this.CMD_UPDATE:this.processUpdate(F,C,D[A]);break;case this.CMD_EVAL:B.globalEval(D[A].firstChild.data);break;case this.CMD_INSERT:this.processInsert(F,C,D[A]);break;case this.CMD_DELETE:this.processDelete(F,C,D[A]);break;case this.CMD_ATTRIBUTES:this.processAttributes(F,C,D[A]);break;case this.CMD_EXTENSION:break;case undefined:break;default:throw this._raiseError(new Error(),"_AjaxResponse.processChanges: Illegal Command Issued","processChanges");}}return true;},processUpdate:function(E,C,D){var H=C._mfInternal;if((D.getAttribute("id").indexOf(this.P_VIEWSTATE)!=-1)||(D.getAttribute("id").indexOf(this.P_CLIENTWINDOW)!=-1)){if(D.getAttribute("id").indexOf(this.P_VIEWSTATE)!=-1){H.appliedViewState=this._Dom.concatCDATABlocks(D);}else{if(D.getAttribute("id").indexOf(this.P_CLIENTWINDOW)!=-1){H.appliedClientWindow=D.firstChild.nodeValue;}}}else{var B=this._Dom.concatCDATABlocks(D),A=null,G=this._Lang.hitch(this,this._pushOperationResult);switch(D.getAttribute("id")){case this.P_VIEWROOT:B=B.substring(B.indexOf("<html"));var F=this._replaceHead(E,C,B);("undefined"!=typeof F&&null!=F)?this._replaceBody(E,C,B,F):this._replaceBody(E,C,B);break;case this.P_VIEWHEAD:this._replaceHead(E,C,B);break;case this.P_VIEWBODY:A=this._replaceBody(E,C,B);if(A){G(C,A);}break;case this.P_RESOURCE:this._addResourceToHead(E,C,B);break;default:A=this.replaceHtmlItem(E,C,D.getAttribute("id"),B);if(A){G(C,A);}break;}}return true;},_pushOperationResult:function(D,B){var G=D._mfInternal;var F=this._Lang.hitch(this,function(I){var H=this._Dom.getParent(I,"form");if(null!=H){G._updateForms.push(H.id||H);}else{G._updateElems.push(I.id||I);}});var A=this._Lang.hitch(this,function(H){if(H.tagName&&this._Lang.equalsIgnoreCase(H.tagName,"form")){if(H.id){G._updateForms.push(H.id);}}else{var J=this._Dom.findByTagName(H,"form");if(J&&J.length){for(var I=0;I<J.length;I++){if(J[I].id){G._updateForms.push(J[I].id);}}}}});var E="undefined"!=typeof B.length&&"undefined"==typeof B.nodeType;if(E&&B.length){for(var C=0;C<B.length;C++){F(B[C]);A(B[C]);}}else{if(!E){F(B);A(B);}}},_replaceHead:function(F,C,L){var D=this._Lang,I=this._Dom,G=this._RT.browser.isWebKit,J=(!G)?D.parseXML(L):null,E=null;if(!G&&D.isXMLParseError(J)){J=D.parseXML(L.replace(/<!\-\-[\s\n]*<!\-\-/g,"<!--").replace(/\/\/-->[\s\n]*\/\/-->/g,"//-->"));}if(G||D.isXMLParseError(J)){var B=new (this._RT.getGlobalConfig("updateParser",myfaces._impl._util._HtmlStripper))();var K=B.parse(L,"head");E=D.parseXML("<head>"+K+"</head>");if(D.isXMLParseError(E)){try{E=I.createElement("head");E.innerHTML=K;}catch(H){throw this._raiseError(new Error(),"Error head replacement failed reason:"+H.toString(),"_replaceHead");}}}else{E=J.getElementsByTagName("head")[0];}var A=I.findByTagNames(document.getElementsByTagName("head")[0],{"link":true,"style":true});I.runCss(E,true);I.deleteItems(A);I.runScripts(E,true);return J;},_addResourceToHead:function(C,A,B){var D=document.getElementsByTagName("head")[0].lastChild;this._Dom.insertAfter(D,B);},_replaceBody:function(E,B,Q){var I=this._RT,M=this._Dom,D=this._Lang,K=document.getElementsByTagName("body")[0],P=document.createElement("div"),F=I.browser.isWebKit;P.id="myfaces_bodyplaceholder";M._removeChildNodes(K);K.innerHTML="";K.appendChild(P);var H,O=null,A;if(!F){O=(arguments.length>3)?arguments[3]:D.parseXML(Q);}if(!F&&D.isXMLParseError(O)){O=D.parseXML(Q.replace(/<!\-\-[\s\n]*<!\-\-/g,"<!--").replace(/\/\/-->[\s\n]*\/\/-->/g,"//-->"));}if(F||D.isXMLParseError(O)){A=new (I.getGlobalConfig("updateParser",myfaces._impl._util._HtmlStripper))();H=A.parse(Q,"body");}else{var J=O.getElementsByTagName("body")[0];var G=I.browser;if(!G.isIEMobile||G.isIEMobile>=7){for(var C=0;C<J.attributes.length;C++){var N=J.attributes[C].value;if(N){M.setAttribute(K,J.attributes[C].name,N);}}}}A=new (I.getGlobalConfig("updateParser",myfaces._impl._util._HtmlStripper))();H=A.parse(Q,"body");var L=this.replaceHtmlItem(E,B,P,H);if(L){this._pushOperationResult(B,L);}return L;},replaceHtmlItem:function(F,C,G,A){var B=this._Lang,E=this._Dom;var D=(!B.isString(G))?G:E.byIdOrName(G);if(!D){throw this._raiseError(new Error(),B.getMessage("ERR_ITEM_ID_NOTFOUND",null,"_AjaxResponse.replaceHtmlItem",(G)?G.toString():"undefined"),"replaceHtmlItem");}return E.outerHTML(D,A,this._RT.getLocalOrGlobalConfig(C,"preserveFocus",false));},processInsert:function(H,C,G){var F=this._Dom,B=this._Lang,E=this._parseInsertData(H,C,G);if(!E){return false;}var D=F.byIdOrName(E.opId);if(!D){throw this._raiseError(new Error(),B.getMessage("ERR_PPR_INSERTBEFID_1",null,"_AjaxResponse.processInsert",E.opId),"processInsert");}var A=F[E.insertType](D,E.cDataBlock);if(A){this._pushOperationResult(C,A);}return true;},_parseInsertData:function(J,C,F){var G=this._Lang,M=this._Dom,H=M.concatCDATABlocks,N="insertBefore",D="insertAfter",B=F.getAttribute("id"),E=F.getAttribute("before"),K=F.getAttribute("after"),L={};if(B&&E&&!K){L.insertType=N;L.opId=E;L.cDataBlock=H(F);}else{if(B&&!E&&K){L.insertType=D;L.opId=K;L.cDataBlock=H(F);}else{if(!B){var I=F.childNodes[0].tagName;if(I!="before"&&I!="after"){throw this._raiseError(new Error(),G.getMessage("ERR_PPR_INSERTBEFID"),"_parseInsertData");}I=I.toLowerCase();var A=F.childNodes[0].getAttribute("id");L.insertType=(I=="before")?N:D;L.opId=A;L.cDataBlock=H(F.childNodes[0]);}else{throw this._raiseError(new Error(),[G.getMessage("ERR_PPR_IDREQ"),"\n ",G.getMessage("ERR_PPR_INSERTBEFID")].join(""),"_parseInsertData");}}}L.opId=G.trim(L.opId);return L;},processDelete:function(G,C,F){var B=this._Lang,E=this._Dom,H=F.getAttribute("id");if(!H){throw this._raiseError(new Error(),B.getMessage("ERR_PPR_UNKNOWNCID",null,"_AjaxResponse.processDelete",""),"processDelete");}var D=E.byIdOrName(H);if(!D){throw this._raiseError(new Error(),B.getMessage("ERR_PPR_UNKNOWNCID",null,"_AjaxResponse.processDelete",H),"processDelete");}var A=this._Dom.getParent(D,"form");if(null!=A){C._mfInternal._updateForms.push(A);}E.deleteItem(D);return true;},processAttributes:function(F,A,C){var D=this._Lang,B=C.getAttribute("id");if(!B){throw this._raiseError(new Error(),"Error in attributes, id not in xml markup","processAttributes");}var K=C.childNodes;if(!K){return false;}for(var I=0;I<K.length;I++){var E=K[I],J=E.getAttribute("name"),H=E.getAttribute("value");if(!J){continue;}J=D.trim(J);if("undefined"==typeof H||null==H){H="";}switch(B){case this.P_VIEWROOT:throw this._raiseError(new Error(),D.getMessage("ERR_NO_VIEWROOTATTR",null,"_AjaxResponse.processAttributes"),"processAttributes");case this.P_VIEWHEAD:throw this._raiseError(new Error(),D.getMessage("ERR_NO_HEADATTR",null,"_AjaxResponse.processAttributes"),"processAttributes");case this.P_VIEWBODY:var G=document.getElementsByTagName("body")[0];this._Dom.setAttribute(G,J,H);break;default:this._Dom.setAttribute(document.getElementById(B),J,H);break;}}return true;},_raiseError:function(D,H,B,F,A){var E=this.attr("impl");var I=F||E.MALFORMEDXML;var G=A||E.MALFORMEDXML;var C=H||"";return this._Lang.makeException(D,I,G,this._nameSpace,B||((arguments.caller)?arguments.caller.toString():"_raiseError"),C);}});